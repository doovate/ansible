- name: Detect full run
  hosts: all
  gather_facts: no
  tasks:
    - name: assert limit
      run_once: yes
      assert:
        that:
          - 'ansible_limit is defined'
        fail_msg: Playbook must be run with a limit

- name: Install controller dependencies
  hosts: all
  gather_facts: no
  run_once: yes
  tasks:
    - name: Install PyJWT and cryptography on controller
      delegate_to: localhost
      pip:
        name:
          - PyJWT
          - cryptography
        state: latest
        break_system_packages: true

- name: Deploy and configure a set of Odoo containers
  hosts: "device_roles_odoo:&prod"
  become: true
  gather_facts: false
  pre_tasks:
    - name: Wait for SSH
      ansible.builtin.wait_for_connection:
        delay: 15
        timeout: 120

    - name: Gather facts
      ansible.builtin.setup:
  roles:
    - docker
    - install_pip
    - cloudflare_dns
    - loki_client
    - odoo_docker_install_packages
    - odoo_docker
    - odoo_docker_watchdog
    - odoo_traefik_dynamic

# We need to wait for Odoo to be ready before configuring web.base.url
- name: Wait for Odoo to be ready and configure web.base.url
  hosts: "device_roles_odoo:&prod"
  become: true
  gather_facts: false
  tasks:
    - name: Flush handlers before configuring
      ansible.builtin.meta: flush_handlers

  roles:
    - odoo_docker_configure_web_base_url
