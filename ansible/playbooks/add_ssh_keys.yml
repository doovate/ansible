- name: Add unknown hosts
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Read known_hosts
      slurp:
        src: "~/.ssh/known_hosts"
      register: known_hosts_content
      ignore_errors: yes

    - name: Verify hosts aren't in known_hosts
      shell: |
        ssh-keygen -F {{ hostvars[item].ansible_host | default(item) }} >/dev/null 2>&1
        echo $?
      loop: "{{ groups['all'] }}"
      register: host_check
      failed_when: false
      changed_when: false

    - name: Obtain unknown hosts keys
      shell: |
        ssh-keyscan -H {{ hostvars[item.item].ansible_host | default(item.item) }} >> ~/.ssh/known_hosts 2>/dev/null
      loop: "{{ host_check.results }}"
      when: item.stdout == "1"  # 1 mean is not in known hosts
      register: new_keys
      failed_when: false

    - name: Delete duplicates
      shell: |
        sort -u ~/.ssh/known_hosts -o ~/.ssh/known_hosts
      when: new_keys.changed
      changed_when: false

    - name: Show added hosts
      debug:
        msg: "Se a√±adieron {{ new_keys.results | selectattr('changed') | list | length }} hosts nuevos"
