- name: Verify there is connection with Cloudflare API
  ansible.builtin.uri:
    url: https://api.cloudflare.com
    method: GET
    timeout: 10
  register: cf_check
  retries: 5
  delay: 10
  until: cf_check.status in [200, 301]

- name: Verify ownership of DNS zones in Cloudflare
  uri:
    url: "https://api.cloudflare.com/client/v4/zones?name={{ item.split('.')[-2:] | join('.') }}"
    headers:
      Authorization: "Bearer {{ lookup('env', 'CLOUDFLARE_TOKEN') }}"
      Content-Type: "application/json"
  register: cf_zone_check
  loop: "{{ domain.split(',') | map('trim') | list }}"
  no_log: true
  when:
    - item is defined
    - item | length > 0

- name: Build list of domains not owned in Cloudflare
  set_fact:
    cf_not_owned: >-
      {{
        (cf_not_owned | default([]))
        + [ item.item ]
      }}
  loop: "{{ cf_zone_check.results }}"
  when:
    - item.skipped is not defined
    - (item.json.result | length) == 0
  loop_control:
    label: "{{ item.item.split('.')[-2:] | join('.') }}"

- name: Fail if any zone is not owned by this Cloudflare account
  fail:
    msg: >-
      One or more subdomains can not be created because the domain is not available:
      {{ cf_not_owned | join(', ') }}
  when: (cf_not_owned | default([]) | length) > 0

- name: Create DNS records for each subdomain
  community.general.cloudflare_dns:
    zone: "{{ item.split('.')[-2:] | join('.') }}"
    record: "{{ item.split('.')[:-2] | join('.') }}"
    type: A
    value: "{{ forward_ip }}"
    api_token: "{{ lookup('env', 'CLOUDFLARE_TOKEN') }}"
    comment: "DNS record created by Ansible for client {{ compose_project_name }}"
  loop: "{{ domain.split(',') | map('trim') | list }}"
  when:
    - item is defined
    - item | length > 0
    - item.split('.') | length > 2
  register: record
