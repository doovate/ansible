- name: Ejecutar Terraform desde Ansible
  hosts: localhost
  gather_facts: false

  vars:
    tf_dir: "./terraform/odoo"
    host:
    domain:

  tasks:
    - name: Check if terraform exists
      ansible.builtin.command: terraform version
      register: tf_version
      changed_when: false

    - name: Delete credentials.auto.tfvars if it exists
      ansible.builtin.file:
        path: "{{ tf_dir }}/credentials.auto.tfvars"
        state: absent

    - name: Generar archivo de configuraciÃ³n
      ansible.builtin.copy:
        content: |
          hostname = "{{ host }}"
          subdomain = "{{ domain }}"
        dest: "{{ tf_dir }}/terraform.tfvars"
        mode: '0644'

    - name: Terraform init
      ansible.builtin.command: >
        terraform init -input=false 
        -reconfigure
        -backend-config="key=odoo/{{ host }}/terraform.tfstate"
      args:
        chdir: "{{ tf_dir }}"

    - name: Terraform plan
      ansible.builtin.command: >
        terraform plan -input=false -no-color
      args:
        chdir: "{{ tf_dir }}"

    - name: Show Terraform outputs
      ansible.builtin.command: >
        terraform output -json
      args:
        chdir: "{{ tf_dir }}"
      register: tf_outputs

    - name: Display outputs
      ansible.builtin.debug:
        msg: "{{ tf_outputs.stdout | from_json }}"

    - name: Terraform apply
      ansible.builtin.command: >
        terraform apply -input=false -auto-approve -no-color
      args:
        chdir: "{{ tf_dir }}"
